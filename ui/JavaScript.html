<!-- JavaScript.html -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    attachNavHandlers();
  });

  // ------------------------------------
  // App Initialization
  // ------------------------------------
  function initializeApp() {
    google.script.run.withSuccessHandler(user => {
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userRole').textContent = formatRole(user.role);

      const isAdmin = ['admin', 'qa_manager'].includes(user.role);
      document.getElementById('navAdmin').style.display = isAdmin ? 'block' : 'none';

      if (['qa_analyst', 'qa_manager'].includes(user.role)) {
        showAuditQueue();
      } else {
        showDashboard();
      }
    }).getCurrentUser();
  }

  // ------------------------------------
  // Navigation
  // ------------------------------------
  function attachNavHandlers() {
    const map = {
      navDashboard: showDashboard,
      navAuditQueue: showAuditQueue,
      navEvaluations: showEvaluations,
      navDisputes: showDisputes,
      navAdmin: showAdmin
    };

    Object.entries(map).forEach(([id, handler]) => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', handler);
    });
  }

  // ------------------------------------
  // View Switching
  // ------------------------------------
  function hideAllViews() {
    document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
  }

  function highlightNavItem(navId) {
    document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
    const btn = document.getElementById(navId);
    if (btn) btn.classList.add('active');
  }

  function showDashboard() {
    hideAllViews();
    document.getElementById('dashboardView')?.classList.remove('hidden');
    highlightNavItem('navDashboard');
  }

  function showAuditQueue() {
    hideAllViews();
    document.getElementById('auditQueueView')?.classList.remove('hidden');
    highlightNavItem('navAuditQueue');
  }

  function showEvaluations() {
    hideAllViews();
    document.getElementById('evaluationsView')?.classList.remove('hidden');
    highlightNavItem('navEvaluations');
    loadEvaluations();
  }

  function showDisputes() {
    hideAllViews();
    document.getElementById('disputesView')?.classList.remove('hidden');
    highlightNavItem('navDisputes');
  }

  function showAdmin() {
    hideAllViews();
    document.getElementById('adminView')?.classList.remove('hidden');
    highlightNavItem('navAdmin');
  }

  // ------------------------------------
  // Evaluations Table
  // ------------------------------------
  function loadEvaluations() {
    const tableBody = document.getElementById('evaluationsBody');
    tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;

    google.script.run.withSuccessHandler(evaluations => {
      if (!evaluations.length) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500">No evaluations found</td></tr>`;
        return;
      }

      tableBody.innerHTML = '';
      evaluations.forEach(evaluation => {
        const percentage = Math.round((evaluation.totalPoints / evaluation.totalPointsPossible) * 100);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formatTaskType(evaluation.taskType)}</td>
          <td>${evaluation.qaEmail}</td>
          <td>${formatDate(evaluation.stopTimestamp)}</td>
          <td>${evaluation.totalPoints}/${evaluation.totalPointsPossible} (${percentage}%)</td>
          <td><span class="badge badge-${evaluation.status}">${evaluation.status}</span></td>
          <td>
            <button class="btn btn-sm btn-primary view-eval-btn" data-id="${evaluation.id}">View</button>
          </td>
        `;
        tableBody.appendChild(row);
      });

      document.querySelectorAll('.view-eval-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const evalId = btn.dataset.id;
          showToast(`You clicked View for evaluation: ${evalId}`, 'info');
          // Placeholder for real viewEvaluation(evalId)
        });
      });
    }).getAllEvaluations();
  }

  // ------------------------------------
  // Toast Notifications
  // ------------------------------------
  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast';

    if (type === 'success') toast.style.backgroundColor = '#38a169';
    else if (type === 'error') toast.style.backgroundColor = '#e53e3e';
    else if (type === 'warning') toast.style.backgroundColor = '#ecc94b';

    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
  }

  // ------------------------------------
  // Formatting Helpers
  // ------------------------------------
  function formatRole(role) {
    return role ? role.split('_').map(capitalize).join(' ') : 'Unknown';
  }

  function formatTaskType(type) {
    return type ? type.split('_').map(capitalize).join(' ') : 'Unknown';
  }

  function capitalize(word) {
    return word.charAt(0).toUpperCase() + word.slice(1);
  }

  function formatDate(dateStr) {
    if (!dateStr) return 'Unknown';
    const date = new Date(dateStr);
    if (isNaN(date)) return dateStr;
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
</script>