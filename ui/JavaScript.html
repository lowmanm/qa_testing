<!-- JavaScript.html -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    attachNavHandlers();
  });

  // ------------------------------------
  // App Initialization
  // ------------------------------------
  function initializeApp() {
    google.script.run.withSuccessHandler(user => {
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userRole').textContent = formatRole(user.role);

      const isAdmin = ['admin', 'qa_manager'].includes(user.role);
      document.getElementById('navAdmin').style.display = isAdmin ? 'block' : 'none';

      if (['qa_analyst', 'qa_manager'].includes(user.role)) {
        showAuditQueue();
      } else {
        showDashboard();
      }
    }).getCurrentUser();
  }

  // ------------------------------------
  // View Switching
  // ------------------------------------
  function hideAllViews() {
    const views = document.querySelectorAll('.view');
    views.forEach(view => view.classList.add('hidden'));
  }

  function highlightNavItem(navId) {
    document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
    const btn = document.getElementById(navId);
    if (btn) btn.classList.add('active');
  }

  function attachNavHandlers() {
    const map = {
      navDashboard: showDashboard,
      navAuditQueue: showAuditQueue,
      navEvaluations: showEvaluations,
      navDisputes: showDisputes,
      navAdmin: showAdmin
    };

    Object.entries(map).forEach(([id, handler]) => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', handler);
    });
  }

  function showDashboard() {
    hideAllViews();
    highlightNavItem('navDashboard');
    document.getElementById('dashboardView')?.classList.remove('hidden');
    loadDashboardStats();
  }

  function showAuditQueue() {
    hideAllViews();
    highlightNavItem('navAuditQueue');
    document.getElementById('auditQueueView')?.classList.remove('hidden');
    loadAuditQueue();
  }

  function showEvaluations() {
    hideAllViews();
    highlightNavItem('navEvaluations');
    document.getElementById('evaluationsView')?.classList.remove('hidden');
    loadEvaluations();
  }

  function showDisputes() {
    hideAllViews();
    highlightNavItem('navDisputes');
    document.getElementById('disputesView')?.classList.remove('hidden');
    loadDisputes();
  }

  function showAdmin() {
    hideAllViews();
    highlightNavItem('navAdmin');
    document.getElementById('adminView')?.classList.remove('hidden');
    loadUsers();
    loadQuestions();
    loadSettings();
  }
  
  function showEvaluationForm() {
    hideAllViews();
    document.getElementById('evaluationFormView')?.classList.remove('hidden');
  }
  
  // ------------------------------------
  // Format Helpers
  // ------------------------------------
  function formatRole(role) {
    return role ? role.split('_').map(capitalize).join(' ') : 'Unknown';
  }

  function formatTaskType(type) {
    return type ? type.split('_').map(capitalize).join(' ') : 'Unknown';
  }

  function capitalize(word) {
    return word.charAt(0).toUpperCase() + word.slice(1);
  }

  function formatDate(dateStr) {
    if (!dateStr) return 'Unknown';
    const date = new Date(dateStr);
    if (isNaN(date)) return dateStr;
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  
  // ------------------------------------
  // Toast Notifications
  // ------------------------------------
  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast';

    if (type === 'success') toast.style.backgroundColor = '#38a169';
    else if (type === 'error') toast.style.backgroundColor = '#e53e3e';
    else if (type === 'warning') toast.style.backgroundColor = '#ecc94b';

    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // ------------------------------------
  // Data Loaders
  // ------------------------------------
  function loadDashboardStats() {
    google.script.run.withSuccessHandler(stats => {
      document.getElementById('pendingAuditsCount').textContent = stats.pending || 0;
      document.getElementById('completedEvalsCount').textContent = stats.completed || 0;
            const percent = stats.evalRate ? Math.round(stats.evalRate * 100) : 0;
      document.getElementById('evalProgressText').textContent = `${percent}%`;
      document.getElementById('evalProgressBar').style.width = `${percent}%`;

      document.getElementById('disputedEvalsCount').textContent = stats.disputes.total || 0;
      document.getElementById('partialOverturns').textContent = stats.disputes.partialOverturns || 0;
      document.getElementById('totalOverturned').textContent = stats.disputes.totalOverturned || 0;
      document.getElementById('disputesUpheld').textContent = stats.disputes.disputesUpheld || 0;
    }).getDashboardStats();
  }

  function loadAuditQueue() {
    const tbody = document.getElementById('pendingTasksBody');
    tbody.innerHTML = `<tr><td colspan="6">Loading...</td></tr>`;

    google.script.run.withSuccessHandler(audits => {
      if (!audits.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500">No pending audits</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      audits.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.agentEmail}</td>
          <td>${formatTaskType(a.taskType)}</td>
          <td>${a.referenceNumber}</td>
          <td>${formatDate(a.taskTimestamp)}</td>
          <td>${a.auditStatus}</td>
          <td><button class="btn btn-primary btn-sm" onclick="startEvaluation('${a.auditId}')">Start</button></td>
        `;
        tbody.appendChild(tr);
      });
    }).getPendingAudits();
  }

  function loadEvaluations() {
    const tableBody = document.getElementById('evaluationsBody');
    tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;

    google.script.run.withSuccessHandler(evaluations => {
      if (!evaluations.length) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500">No evaluations found</td></tr>`;
        return;
      }

      tableBody.innerHTML = '';
      evaluations.forEach(eval => {
        const percentage = Math.round((eval.totalPoints / eval.totalPointsPossible) * 100);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formatTaskType(eval.taskType)}</td>
          <td>${eval.qaEmail}</td>
          <td>${formatDate(eval.stopTimestamp)}</td>
          <td>${eval.totalPoints}/${eval.totalPointsPossible} (${percentage}%)</td>
          <td><span class="badge badge-${eval.status}">${eval.status}</span></td>
          <td>
            <button class="btn btn-sm btn-primary" disabled>View</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }).getAllEvaluations();
  }
  
    function loadDisputes() {
    const tableBody = document.getElementById('disputesBody');
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center">Loading...</td></tr>`;

    google.script.run.withSuccessHandler(disputes => {
      if (!disputes.length) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500">No disputes found</td></tr>`;
        return;
      }

      tableBody.innerHTML = '';
      disputes.forEach(d => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${d.evalId}</td>
          <td>${d.userEmail}</td>
          <td>${formatDate(d.disputeTimestamp)}</td>
          <td><span class="badge badge-${d.status}">${d.status}</span></td>
          <td><button class="btn btn-sm btn-primary" disabled>View</button></td>
        `;
        tableBody.appendChild(row);
      });
    }).getAllDisputes();
  }

  function loadUsers() {
    const tableBody = document.getElementById('usersBody');
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center">Loading...</td></tr>`;

    google.script.run.withSuccessHandler(users => {
      if (!users.length) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500">No users found</td></tr>`;
        return;
      }

      tableBody.innerHTML = '';
      users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${formatRole(user.role)}</td>
          <td>${user.managerEmail || '-'}</td>
          <td>
            <button class="btn btn-sm btn-outline" onclick="editUser('${user.id}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }).getAllUsers();
  }

  function startEvaluation(auditId) {
    google.script.run.withSuccessHandler(audit => {
      showEvaluationForm();
      populateEvaluationForm(audit);
    }).prepareEvaluation(auditId);
  }

  function populateEvaluationForm(audit) {
    document.getElementById('taskDetails').innerHTML = `
      <p><strong>Reference:</strong> ${audit.referenceNumber}</p>
      <p><strong>Task Type:</strong> ${formatTaskType(audit.taskType)}</p>
      <p><strong>Agent:</strong> ${audit.agentEmail}</p>
    `;

    document.getElementById('evaluationForm').reset();
    document.getElementById('feedbackCounter').textContent = '';
    document.getElementById('evaluationForm').dataset.auditId = audit.auditId;

    const container = document.getElementById('questions');
    container.innerHTML = `<p>Loading questions...</p>`;

    google.script.run.withSuccessHandler(questions => {
      container.innerHTML = '';
      questions.forEach((q, index) => {
        const questionEl = document.createElement('div');
        questionEl.className = 'question';

        questionEl.innerHTML = `
          <label><strong>Q${index + 1}: ${q.questionText}</strong></label>
          <div>
            <select name="response-${q.id}" class="form-control">
              <option value="">-- Select --</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
              <option value="na">N/A</option>
            </select>
          </div>
          <div class="form-group">
            <label>Feedback</label>
            <textarea name="feedback-${q.id}" rows="2" class="form-control"></textarea>
          </div>
        `;
        container.appendChild(questionEl);
      });
    }).getQuestionsForTaskType(audit.taskType);
  }
  
    // ------------------------------------
  // Evaluation Form Submission
  // ------------------------------------
  document.getElementById('evaluationForm')?.addEventListener('submit', e => {
    e.preventDefault();

    const form = e.target;
    const auditId = form.dataset.auditId;
    const questionsEls = form.querySelectorAll('.question');
    const feedback = form.querySelector('#feedback').value;

    const questions = Array.from(questionsEls).map(el => {
      const questionText = el.querySelector('label strong').textContent.split(': ')[1];
      const select = el.querySelector('select');
      const response = select.value;
      const pointsPossible = 1;
      const pointsEarned = response === 'yes' ? 1 : 0;
      const feedbackText = el.querySelector('textarea').value;

      return {
        questionId: select.name.split('-')[1],
        questionText,
        response,
        pointsEarned,
        pointsPossible,
        feedback: feedbackText
      };
    });

    const totalPoints = questions.reduce((sum, q) => sum + q.pointsEarned, 0);
    const totalPointsPossible = questions.length;

    const payload = {
      auditId,
      taskType: '',
      referenceNumber: '',
      questions,
      feedback,
      totalPoints,
      totalPointsPossible
    };

    google.script.run.withSuccessHandler(() => {
      showToast('Evaluation saved successfully', 'success');
      showEvaluations();
    }).saveEvaluation(payload);
  });

  // ------------------------------------
  // Feedback Character Counter
  // ------------------------------------
  document.getElementById('feedback')?.addEventListener('input', e => {
    const max = 300;
    const len = e.target.value.length;
    const counter = document.getElementById('feedbackCounter');
    counter.textContent = `${len}/${max}`;
    counter.style.color = len > max ? 'red' : '#6b7280';
  });

  // ------------------------------------
  // User Form
  // ------------------------------------
  document.getElementById('addUserBtn')?.addEventListener('click', () => {
    document.getElementById('userFormTitle').textContent = 'Add User';
    document.getElementById('userFormElement').reset();
    document.getElementById('userId').value = '';
    document.getElementById('userForm').classList.remove('hidden');
  });

  document.getElementById('cancelUserForm')?.addEventListener('click', () => {
    document.getElementById('userForm').classList.add('hidden');
  });

  document.getElementById('userFormElement')?.addEventListener('submit', e => {
    e.preventDefault();

    const form = new FormData(e.target);
    const userData = {
      id: form.get('userId') || '',
      name: form.get('userName'),
      email: form.get('userEmail'),
      role: form.get('userRole'),
      managerEmail: form.get('userManager') || ''
    };

    const fn = userData.id ? 'updateUser' : 'createUser';

    google.script.run.withSuccessHandler(() => {
      showToast('User saved successfully', 'success');
      document.getElementById('userForm').classList.add('hidden');
      loadUsers();
    })[fn](userData);
  });

  function editUser(userId) {
    google.script.run.withSuccessHandler(users => {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      document.getElementById('userFormTitle').textContent = 'Edit User';
      document.getElementById('userId').value = user.id;
      document.getElementById('userFormName').value = user.name;
      document.getElementById('userEmail').value = user.email;
      document.getElementById('userFormRole').value = user.role;
      document.getElementById('userManager').value = user.managerEmail;

      document.getElementById('userForm').classList.remove('hidden');
    }).getAllUsers();
  }

  function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    google.script.run.withSuccessHandler(() => {
      showToast('User deleted', 'success');
      loadUsers();
    }).deleteUser(userId);
  }
  
    // ------------------------------------
  // Admin Tab Switching
  // ------------------------------------
  document.querySelectorAll('.admin-tab-item')?.forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.admin-tab-item').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const tabId = btn.id.replace('admin', '').toLowerCase();
      document.querySelectorAll('.admin-tab-content').forEach(tab => tab.classList.add('hidden'));
      document.getElementById(`admin${capitalize(tabId)}View`)?.classList.remove('hidden');

      if (tabId === 'users') loadUsers();
      else if (tabId === 'questions') loadQuestions();
    });
  });

  // ------------------------------------
  // Settings Save
  // ------------------------------------
  document.getElementById('settingsForm')?.addEventListener('submit', e => {
    e.preventDefault();
    const form = new FormData(e.target);
    const settings = {
      emailSubject: form.get('emailSubject'),
      csvFilename: form.get('csvFilename'),
      feedbackCharLimit: parseInt(form.get('feedbackCharLimit'), 10)
    };

    google.script.run.withSuccessHandler(() => {
      showToast('Settings saved successfully', 'success');
    }).saveSettings(settings);
  });

  // ------------------------------------
  // Dispute Resolution
  // ------------------------------------
  document.getElementById('resolveDisputeForm')?.addEventListener('submit', e => {
    e.preventDefault();

    const form = e.target;
    const disputeId = form.dataset.disputeId;
    const evalId = form.dataset.evalId;
    const resolutionNotes = form.querySelector('#resolutionNotes').value;

    const decisions = Array.from(form.querySelectorAll('.dispute-question')).map(el => {
      const questionId = el.dataset.questionId;
      const resolution = el.querySelector('select').value;
      const note = el.querySelector('textarea').value;
      return { questionId, resolution, note };
    });

    const payload = {
      disputeId,
      evalId,
      decisions,
      resolutionNotes,
      status: 'resolved'
    };

    google.script.run.withSuccessHandler(() => {
      showToast('Dispute resolved', 'success');
      showDisputes();
    }).resolveDispute(payload);
  });
  
    // ------------------------------------
  // Dispute Form Submission
  // ------------------------------------
  document.getElementById('disputeForm')?.addEventListener('submit', e => {
    e.preventDefault();
    const reason = document.getElementById('disputeReason')?.value?.trim();
    const evalId = e.target.dataset.evalId;
    const questionIds = Array.from(e.target.querySelectorAll('.question-dispute-checkbox'))
      .filter(c => c.checked)
      .map(c => c.dataset.questionId);

    if (!reason) {
      showToast('Reason is required', 'warning');
      return;
    }

    if (!questionIds.length) {
      showToast('Please select at least one question to dispute.', 'warning');
      return;
    }

    const payload = { evalId, reason, questionIds };

    google.script.run.withSuccessHandler(() => {
      showToast('Dispute submitted successfully', 'success');
      showDisputes();
    }).saveDispute(payload);
  });

  // ------------------------------------
  // Load Audit Queue
  // ------------------------------------
  function loadAuditQueue() {
    const tbody = document.getElementById('pendingTasksBody');
    tbody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;

    google.script.run.withSuccessHandler(audits => {
      if (!audits.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500">No pending audits</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      audits.forEach(a => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${a.agentEmail}</td>
          <td>${formatTaskType(a.taskType)}</td>
          <td>${a.referenceNumber}</td>
          <td>${formatDate(a.taskTimestamp)}</td>
          <td>${a.auditStatus}</td>
          <td><button class="btn btn-sm btn-primary" onclick="startEvaluation('${a.auditId}')">Evaluate</button></td>
        `;
        tbody.appendChild(row);
      });
    }).getPendingAudits();
  }

  // ------------------------------------
  // Load Dashboard
  // ------------------------------------
  function loadDashboardStats() {
    google.script.run.withSuccessHandler(data => {
      document.getElementById('pendingAuditsCount').textContent = data.pendingCount || 0;
      document.getElementById('completedEvalsCount').textContent = data.completedCount || 0;

      const pct = data.evalPercent || 0;
      document.getElementById('evalProgressText').textContent = `${pct}%`;
      document.getElementById('evalProgressBar').style.width = `${pct}%`;

      document.getElementById('disputedEvalsCount').textContent = data.disputeStats.total;
      document.getElementById('partialOverturns').textContent = data.disputeStats.partialOverturns;
      document.getElementById('totalOverturned').textContent = data.disputeStats.totalOverturned;
      document.getElementById('disputesUpheld').textContent = data.disputeStats.disputesUpheld;
    }).getDashboardMetrics();
  }

  function showDashboard() {
    hideAllViews();
    document.getElementById('dashboardView')?.classList.remove('hidden');
    highlightNavItem('navDashboard');
    loadDashboardStats();
  }

  function showAuditQueue() {
    hideAllViews();
    document.getElementById('auditQueueView')?.classList.remove('hidden');
    highlightNavItem('navAuditQueue');
    loadAuditQueue();
  }
</script>