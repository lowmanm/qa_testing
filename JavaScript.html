<script>
  document.addEventListener('DOMContentLoaded', () => {
  initializeApp();
  attachNavHandlers();
  attachFormHandlers();
  attachAdminHandlers();
  attachDisputeHandlers();
});

  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'toast';

    if (type === 'success') toast.style.backgroundColor = '#28a745';
    else if (type === 'error') toast.style.backgroundColor = '#dc3545';
    else if (type === 'warning') toast.style.backgroundColor = '#ffc107';

    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
  }

  document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    attachNavHandlers();
    attachFormHandlers();
    attachAdminHandlers();
    attachDisputeHandlers();
  });

  function initializeApp() {
    google.script.run.withSuccessHandler(user => {
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userRole').textContent = formatRole(user.role);

      const isAdmin = user.role === 'admin' || user.role === 'qa_manager';
      document.getElementById('navAdmin').style.display = isAdmin ? 'block' : 'none';

      if (user.role === 'qa_analyst' || user.role === 'qa_manager') {
        showAuditQueue();
      } else {
        showDashboard();
      }
    }).getCurrentUser();
  }

  function formatRole(role) {
    return role
      ? role.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
      : 'Unknown';
  }

  function attachNavHandlers() {
  const nav = [
    ['navDashboard', showDashboard],
    ['navAuditQueue', showAuditQueue],
    ['navEvaluations', showEvaluations],
    ['navDisputes', showDisputes],
    ['navAdmin', showAdmin]
  ];

  nav.forEach(([id, handler]) => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('click', handler);
  });
}

  function attachDisputeHandlers() {
    const form = document.getElementById('resolveDisputeForm');
    if (!form) return;

  form.addEventListener('submit', handleResolveDisputeSubmit);
}

  function showDashboard() {
    hideAllViews();
    document.getElementById('dashboardView')?.classList.remove('hidden');
    highlightNavItem('navDashboard');
    document.getElementById('dashboardStatsCard')?.classList.remove('hidden');
    document.getElementById('importAuditCard')?.classList.remove('hidden');
    loadDashboardStats();
  }

  function handleDashboardNav(targetFn) {
    document.getElementById('dashboardStatsCard')?.classList.add('hidden');
    document.getElementById('importAuditCard')?.classList.add('hidden');
    targetFn();
  }

   function loadDashboardStats() {
    // Step 1: Get pending audits
    google.script.run.withSuccessHandler(function(audits) {
      const total = audits.length;
      document.getElementById('pendingAuditsCount').textContent = total;

      // Step 2: Get completed evaluations
      google.script.run.withSuccessHandler(function(evaluations) {
        const completed = evaluations.filter(e => e.status === 'completed').length;
        document.getElementById('completedEvalsCount').textContent = completed;

        // Step 3: Calculate completion %
        const percentage = total === 0 ? 0 : Math.round((completed / total) * 100);

        const bar = document.getElementById('evalProgressBar');
        const text = document.getElementById('evalProgressText');

        // Determine progress bar color class
        let progressClass = 'progress-green';
        if (percentage < 70) progressClass = 'progress-red';
        else if (percentage < 90) progressClass = 'progress-yellow';

        // Update bar and text
        bar.style.width = percentage + '%';
        bar.className = `progress-bar-fill ${progressClass}`;
        text.textContent = percentage + '%';

      }).getAllEvaluations();
    }).getPendingAudits();

    // Step 4: Load dispute stats
    google.script.run.withSuccessHandler(function(stats) {
      document.getElementById('disputedEvalsCount').textContent = stats.total;
      document.getElementById('partialOverturns').textContent = stats.partialOverturns;
      document.getElementById('totalOverturned').textContent = stats.totalOverturned;
      document.getElementById('disputesUpheld').textContent = stats.disputesUpheld;
    }).getDisputeStats();
  }

  // == Form + Button Event Handlers ==
  function attachFormHandlers() {
  const cancelEval = document.getElementById('cancelEvaluation');
  const evalForm = document.getElementById('evaluationForm');
  if (cancelEval) cancelEval.addEventListener('click', showAuditQueue);
  if (evalForm) evalForm.addEventListener('submit', handleEvaluationSubmit);

  const cancelDispute = document.getElementById('cancelDispute');
  const disputeForm = document.getElementById('disputeForm');
  if (cancelDispute) cancelDispute.addEventListener('click', showEvaluations);
  if (disputeForm) disputeForm.addEventListener('submit', handleDisputeSubmit);

  const importBtn = document.getElementById('importButton');
  if (importBtn) {
    importBtn.addEventListener('click', () => {
      const statusDiv = document.getElementById('importStatus');
      if (!statusDiv) return;

      statusDiv.innerHTML = '<div class="alert alert-info">Importing data from email... This may take a moment.</div>';

      google.script.run
        .withSuccessHandler(result => {
          statusDiv.innerHTML = result.success
            ? `<div class="alert alert-success">${result.message}</div>`
            : `<div class="alert alert-danger">${result.message}</div>`;
          if (result.success) loadDashboardStats();
        })
        .withFailureHandler(error => {
          statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        })
        .importDataFromEmail();
    });
  }
}

 function attachAdminHandlers() {
  const userBtn = document.getElementById('adminUsers');
  const qBtn = document.getElementById('adminQuestions');
  const setBtn = document.getElementById('adminSettings');

  if (userBtn) {
    userBtn.addEventListener('click', () => {
      showAdminTab('adminUsersView');
      loadUsers();
      hideUserForm();
    });
  }

  if (qBtn) {
    qBtn.addEventListener('click', () => {
      showAdminTab('adminQuestionsView');
      loadQuestions();
    });
  }

  if (setBtn) {
    setBtn.addEventListener('click', () => {
      showAdminTab('adminSettingsView');
    });
  }

  const addUserBtn = document.getElementById('addUserBtn');
  if (addUserBtn) addUserBtn.addEventListener('click', showAddUserForm);

  const cancelUser = document.getElementById('cancelUserForm');
  if (cancelUser) cancelUser.addEventListener('click', hideUserForm);

  const userForm = document.getElementById('userFormElement');
  if (userForm) userForm.addEventListener('submit', handleUserFormSubmit);

  const addQ = document.getElementById('addQuestionBtn');
  const cancelQ = document.getElementById('cancelQuestionForm');
  const qForm = document.getElementById('questionFormElement');
  const filter = document.getElementById('taskTypeFilter');

  if (addQ) addQ.addEventListener('click', showAddQuestionForm);
  if (cancelQ) cancelQ.addEventListener('click', hideQuestionForm);
  if (qForm) qForm.addEventListener('submit', handleQuestionFormSubmit);
  if (filter) filter.addEventListener('change', loadQuestions);
}

  // Show the Add User form with cleared values
function showAddUserForm() {
  showUserForm();  // This calls the already defined generic showUserForm()
}

// Show the Add Question form with cleared values
function showAddQuestionForm() {
  showQuestionForm(); // This calls the already defined generic showQuestionForm()
}

  function highlightNavItem(navId) {
    document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(navId)?.classList.add('active');
  }

  function showDashboard() {
    hideAllViews();
    document.getElementById('dashboardView')?.classList.remove('hidden');
    highlightNavItem('navDashboard');
    loadDashboardStats();
    document.getElementById('dashboardStatsCard')?.classList.remove('hidden');
    document.getElementById('importAuditCard')?.classList.remove('hidden');
  }

  function handleDashboardNav(targetFn) {
    document.getElementById('dashboardStatsCard')?.classList.add('hidden');
    document.getElementById('importAuditCard')?.classList.add('hidden');
    targetFn();
  }

  function showEvaluations() {
    hideAllViews();
    document.getElementById('evaluationsView')?.classList.remove('hidden');
    highlightNavItem('navEvaluations');
    loadEvaluations();
  }

  function showDisputes() {
    hideAllViews();
    document.getElementById('disputesView')?.classList.remove('hidden');
    highlightNavItem('navDisputes');
    loadDisputes();
  }

  function showAdmin() {
    hideAllViews();
    document.getElementById('adminView')?.classList.remove('hidden');
    highlightNavItem('navAdmin');
    showAdminTab('adminUsersView');
    loadUsers();
    hideUserForm();
  }

  function showAdminTab(tabId) {
    document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(tabId)?.classList.remove('hidden');

    document.querySelectorAll('.admin-tab-item').forEach(tab => tab.classList.remove('active'));
    const tabButtonMap = {
      'adminUsersView': 'adminUsers',
      'adminQuestionsView': 'adminQuestions',
      'adminSettingsView': 'adminSettings'
    };
    const activeBtn = tabButtonMap[tabId];
    document.getElementById(activeBtn)?.classList.add('active');
  }

  function showAuditQueue() {
    hideAllViews();
    document.getElementById('auditQueueView').classList.remove('hidden');
    highlightNavItem('navAuditQueue');
    loadPendingTasks();
}

  function loadPendingTasks() {
  const tableBody = document.getElementById('pendingTasksBody');
  tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

  google.script.run.withSuccessHandler(function(audits) {
    if (audits.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No pending audits found</td></tr>';
      return;
    }

    const fragment = document.createDocumentFragment();
    audits.forEach(function(audit) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${audit.agentEmail}</td>
        <td>${formatTaskType(audit.taskType)}</td>
        <td>${audit.referenceNumber || 'N/A'}</td>
        <td>${formatDate(audit.taskTimestamp)}</td>
        <td><span class="badge badge-${audit.auditStatus}">${audit.auditStatus}</span></td>
        <td>
          <button class="evaluate-button btn btn-sm btn-primary" data-audit-id="${audit.auditId}">Evaluate</button>
        </td>
      `;
      fragment.appendChild(row);
    });

    tableBody.innerHTML = '';
    tableBody.appendChild(fragment);
  }).getPendingAudits();

  // Delegate event for all evaluate buttons
  tableBody.addEventListener('click', function(event) {
    if (event.target.classList.contains('evaluate-button')) {
      const auditId = event.target.getAttribute('data-audit-id');
      showEvaluationForm(auditId);
    }
  });
}

  function updateAuditStatusAndLock(auditId, status) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .updateAuditStatusAndLock(auditId, status);
  });
}

  function showEvaluationForm(auditId) {
  hideAllViews();
  document.getElementById('evaluationFormView').classList.remove('hidden');

  const form = document.getElementById('evaluationForm');
  const taskDetails = document.getElementById('taskDetails');
  const questionsContainer = document.getElementById('questions');
  const feedbackField = document.getElementById('feedback');

  // Clear old state
  form.reset();
  questionsContainer.innerHTML = '';
  taskDetails.innerHTML = 'Loading task details...';
  feedbackField.value = '';
  ['data-audit-id', 'data-reference-number', 'data-task-type', 'data-outcome', 'data-max-score'].forEach(attr => form.removeAttribute(attr));

  // Fetch and render new audit
  google.script.run.withSuccessHandler(function(audit) {
    taskDetails.innerHTML = `
      <div class="grid-2">
        <div><p class="field-label">Agent</p><p class="field-value">${audit.agentEmail}</p></div>
        <div><p class="field-label">Task Type</p><p class="field-value">${formatTaskType(audit.taskType)}</p></div>
        <div><p class="field-label">Reference Number</p><p class="field-value">${audit.referenceNumber || 'N/A'}</p></div>
        <div><p class="field-label">Date</p><p class="field-value">${formatDate(audit.taskTimestamp)}</p></div>
        <div><p class="field-label">Request Type</p><p class="field-value">${formatTaskType(audit.requestType || 'N/A')}</p></div>
        <div><p class="field-label">Outcome</p><p class="field-value">${audit.outcome || 'N/A'}</p></div>
      </div>
    `;

    // Form metadata
    form.setAttribute('data-audit-id', auditId);
    form.setAttribute('data-reference-number', audit.referenceNumber || '');
    form.setAttribute('data-task-type', audit.taskType || '');
    form.setAttribute('data-outcome', audit.outcome || '');

    // Load relevant questions
    loadQuestionsForEvaluation(audit.taskType);
  }).prepareEvaluation(auditId);
}

  function loadQuestionsForEvaluation(taskType, attempt = 1) {
  const maxRetries = 5;
  const questionsContainer = document.getElementById('questions');
  const form = document.getElementById('evaluationForm');

  if (!questionsContainer) {
    if (attempt < maxRetries) {
      return setTimeout(() => loadQuestionsForEvaluation(taskType, attempt + 1), 300);
    } else {
      alert('Failed to load questions. Please return to the Audit Queue and try again.');
      return;
    }
  }

  questionsContainer.innerHTML = '<div class="loading">Loading questions...</div>';

  google.script.run.withSuccessHandler(function(questions) {
    let maxPossibleScore = 0;
    questionsContainer.innerHTML = '';

    if (questions.length === 0) {
  showToast("No evaluation questions are set up for this task type.", 'error');
  markAuditAsMisconfigured(form.getAttribute('data-audit-id'));
  showAuditQueue(); // return user to queue
  return;
}

function markAuditAsMisconfigured(auditId) {
  if (!auditId) return;
  google.script.run.markAuditMisconfigured(auditId);
}

    questions.forEach(q => {
      maxPossibleScore += parseInt(q.pointsPossible || 0);

      const questionCard = document.createElement('div');
      questionCard.className = 'question-card';
      questionCard.setAttribute('data-question-id', q.id);
      questionCard.setAttribute('data-question-text', q.questionText);
      questionCard.setAttribute('data-points-possible', q.pointsPossible);

      questionCard.innerHTML = `
        <div class="question-header">
          <h3 class="question-text">${q.questionText}</h3>
          <span class="question-points">Points: ${q.pointsPossible}</span>
        </div>
        <div class="question-body">
          <div class="radio-group">
            <label><input type="radio" name="question_${q.id}" value="yes"> <span>Yes</span></label>
            <label><input type="radio" name="question_${q.id}" value="no"> <span>No</span></label>
          </div>
          <div class="feedback-field">
            <label for="feedback_${q.id}">Specific Feedback:</label>
            <textarea id="feedback_${q.id}" name="feedback_${q.id}" rows="2" class="form-control"></textarea>
          </div>
        </div>
      `;
      questionsContainer.appendChild(questionCard);
    });

    form.setAttribute('data-max-score', maxPossibleScore);
  }).getQuestionsForTaskType(taskType);
}

  function handleEvaluationSubmit(e) {
  e.preventDefault();

  const form = document.getElementById('evaluationForm');
  if (!form) return showToast("Evaluation form not found.", 'error');

  const auditId = form.getAttribute('data-audit-id');
  const maxPossibleScore = parseInt(form.getAttribute('data-max-score') || 0);
  const referenceNumber = form.getAttribute('data-reference-number');
  const taskType = form.getAttribute('data-task-type');
  const outcome = form.getAttribute('data-outcome');
  const feedbackField = document.getElementById('feedback');
  const feedback = feedbackField ? feedbackField.value : '';

  // Validation: all questions must be answered
  // Validation: all visible questions must be answered
let allAnswered = true;
document.querySelectorAll('#questions .question-card').forEach(function (questionCard) {
  const questionId = questionCard.getAttribute('data-question-id');
  const selectedOption = questionCard.querySelector(`input[name="question_${questionId}"]:checked`);
  if (!selectedOption) allAnswered = false;
});

if (!allAnswered) {
  showToast("Please answer all questions before submitting the evaluation.", 'warning');
  return;
}

  // Compile responses
  let score = 0;
  const questions = [];

  document.querySelectorAll('.question-card').forEach(function (questionCard) {
    const questionId = questionCard.getAttribute('data-question-id');
    const questionText = questionCard.getAttribute('data-question-text');
    const pointsPossible = parseInt(questionCard.getAttribute('data-points-possible') || 0);
    const selectedOption = document.querySelector(`input[name="question_${questionId}"]:checked`);
    const response = selectedOption ? selectedOption.value : 'no';
    const questionFeedbackField = document.getElementById(`feedback_${questionId}`);
    const questionFeedback = questionFeedbackField ? questionFeedbackField.value : '';
    const pointsEarned = response === 'yes' ? pointsPossible : 0;

    score += pointsEarned;
    questions.push({
      questionId,
      questionText,
      response,
      pointsEarned,
      pointsPossible,
      feedback: questionFeedback
    });
  });

  const evaluationData = {
    auditId,
    referenceNumber,
    taskType,
    outcome,
    qaEmail: '',
    startTimestamp: new Date().toISOString(),
    totalPoints: score,
    totalPointsPossible: maxPossibleScore,
    status: 'completed',
    feedback,
    questions
  };

  // UI: Show loading state
  form.classList.add('hidden');
  const loadingIndicator = document.createElement('div');
  loadingIndicator.id = 'evaluationLoadingIndicator';
  loadingIndicator.className = 'loading';
  loadingIndicator.innerText = 'Saving evaluation...';
  document.getElementById('evaluationFormView').appendChild(loadingIndicator);

  google.script.run
    .withSuccessHandler(function () {
      updateAuditStatusAndLock(auditId, 'evaluated')
        .then(() => {
          showToast("Evaluation saved and audit unlocked successfully!", 'success');
          resetEvaluationForm();
          document.getElementById('evaluationLoadingIndicator')?.remove();
          form.classList.remove('hidden');
          showAuditQueue();
        })
        .catch(error => {
          console.error('Error updating audit status:', error);
          showToast("Failed to unlock the record. Try again.", 'error');
          document.getElementById('evaluationLoadingIndicator')?.remove();
          form.classList.remove('hidden');
        });
    })
    .withFailureHandler(function (error) {
      showToast("Error saving evaluation: " + error.message, 'error');
      document.getElementById('evaluationLoadingIndicator')?.remove();
      form.classList.remove('hidden');
    })
    .saveEvaluation(evaluationData);
}

  function resetEvaluationForm() {
  const form = document.getElementById('evaluationForm');
  form.reset();

  const questionsContainer = document.getElementById('questions');
  if (questionsContainer) questionsContainer.innerHTML = '';

  const feedbackField = document.getElementById('feedback');
  if (feedbackField) feedbackField.value = '';

  ['data-audit-id', 'data-reference-number', 'data-task-type', 'data-outcome', 'data-max-score'].forEach(attr =>
    form.removeAttribute(attr)
  );
}

  function loadEvaluations() {
  const tableBody = document.getElementById('evaluationsBody');
  tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

  google.script.run.withSuccessHandler(function(evaluations) {
    if (!evaluations.length) {
      tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No evaluations found</td></tr>';
      return;
    }

    tableBody.innerHTML = '';

    evaluations.forEach(e => {
      const percentage = Math.round((e.totalPoints / e.totalPointsPossible) * 100);
      let scoreClass = 'score-high';
      if (percentage < 70) scoreClass = 'score-low';
      else if (percentage < 90) scoreClass = 'score-medium';

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${formatTaskType(e.taskType)}</td>
        <td>${e.qaEmail}</td>
        <td>${formatDate(e.stopTimestamp)}</td>
        <td class="evaluation-score ${scoreClass}">${e.totalPoints}/${e.totalPointsPossible} (${percentage}%)</td>
        <td><span class="badge badge-${e.status}">${e.status}</span></td>
        <td>
          <button class="btn btn-sm btn-primary view-evaluation-button" data-evaluation-id="${e.id}">View</button>
          ${e.status === 'completed' ? `<button class="btn btn-sm btn-danger ml-2 dispute-button" data-evaluation-id="${e.id}">Dispute</button>` : ''}
        </td>
      `;
      tableBody.appendChild(row);
    });

    // Delegate event listeners
    document.querySelectorAll('.view-evaluation-button').forEach(btn =>
      btn.addEventListener('click', () => viewEvaluation(btn.dataset.evaluationId))
    );
    document.querySelectorAll('.dispute-button').forEach(btn =>
      btn.addEventListener('click', () => showDisputeForm(btn.dataset.evaluationId))
    );
  }).getAllEvaluations();
}

  function viewEvaluation(evaluationId) {
  hideAllViews();
  document.getElementById('viewEvaluationView').classList.remove('hidden');

  google.script.run.withSuccessHandler(function(evaluations) {
    const evaluation = evaluations.find(e => e.id === evaluationId);
    if (!evaluation) return alert("Evaluation not found.");

    document.getElementById('viewEvaluationDetails').innerHTML = `
      <div class="grid-2">
        <div><p class="field-label">Task Type</p><p class="field-value">${formatTaskType(evaluation.taskType)}</p></div>
        <div><p class="field-label">Date</p><p class="field-value">${formatDate(evaluation.stopTimestamp)}</p></div>
        <div><p class="field-label">Reference</p><p class="field-value">${evaluation.referenceNumber || 'N/A'}</p></div>
        <div><p class="field-label">QA Agent</p><p class="field-value">${evaluation.qaEmail}</p></div>
        <div class="grid-span-2"><p class="field-label">Feedback</p><p class="field-value">${evaluation.feedback || 'No feedback provided.'}</p></div>
      </div>
    `;

    const container = document.getElementById('viewEvaluationQuestions');
    container.innerHTML = '';

    evaluation.questions.forEach(q => {
      const highlightClass = q.response === 'no' ? 'highlight-no' : '';
      container.innerHTML += `
        <div class="question-card ${highlightClass}">
          <div class="question-header">
            <h3 class="question-text">${q.questionText}</h3>
            <span class="question-points">Score: ${q.pointsEarned}/${q.pointsPossible}</span>
          </div>
          <div class="question-body">
            <p class="field-label">Response:</p>
            <p class="field-value">${q.response === 'yes' ? 'Yes' : 'No'}</p>
            ${q.feedback ? `<p class="field-label">Feedback:</p><p class="field-value">${q.feedback}</p>` : ''}
          </div>
        </div>
      `;
    });
  }).getAllEvaluations();
}

  // Load disputes
  function loadDisputes() {
    var tableBody = document.getElementById('disputesBody');
    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

    // Get disputes
    google.script.run.withSuccessHandler(function(disputes) {
      if (disputes.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">No disputes found</td></tr>';
        return;
      }

      tableBody.innerHTML = '';

      disputes.forEach(function(dispute) {
        var row = document.createElement('tr');

        row.innerHTML = `
          <td>Evaluation #${dispute.evalId}</td>
          <td>${dispute.userEmail}</td>
          <td>${formatDate(dispute.disputeTimestamp)}</td>
          <td><span class="badge badge-${dispute.status}">${dispute.status}</span></td>
          <td>
            <button class="resolve-dispute-button btn btn-sm btn-primary"
              data-dispute-id="${dispute.id}">View</button>
          </td>
        `;

        tableBody.appendChild(row);
      });

      // Add event listeners to view dispute buttons
      document.querySelectorAll('.resolve-dispute-button').forEach(button => {
  button.addEventListener('click', function () {
    const id = this.getAttribute('data-dispute-id');
    resolveDispute(id);
  });
});

    }).getAllDisputes();
  }

  function showDisputeForm(evaluationId) {
  hideAllViews();

  const disputeFormView = document.getElementById('disputeFormView');
  disputeFormView.classList.remove('hidden');

  // 🔄 Rebuild the form HTML to reset previous "Submitting..." or stale state
  disputeFormView.innerHTML = `
    <div class="card">
      <h2>Dispute Evaluation</h2>
      <p>Please provide the details for your dispute below. Ensure all required fields are filled out.</p>
      <div id="evaluationDetails" class="evaluation-details mb-4">Loading evaluation details...</div>

      <form id="disputeForm">
        <div id="disputeQuestions" class="questions-container mb-4">Loading questions...</div>

        <div class="form-group mb-4">
          <label for="disputeReason">Reason for Dispute <span class="required">*</span></label>
          <textarea id="disputeReason" name="disputeReason" rows="3" class="form-control" required></textarea>
          <div class="invalid-feedback">Please provide a reason for the dispute.</div>
        </div>

        <div class="button-group">
          <button type="button" id="cancelDispute" class="btn btn-secondary">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit Dispute</button>
        </div>
      </form>
    </div>
  `;

  // 🧩 Re-attach event listeners after DOM was rebuilt
  document.getElementById('cancelDispute').addEventListener('click', showEvaluations);
  document.getElementById('disputeForm').addEventListener('submit', handleDisputeSubmit);

  // 🔍 Load evaluation details and questions
  google.script.run.withSuccessHandler(function(evaluations) {
    const evaluation = evaluations.find(e => e.id === evaluationId);

    if (!evaluation) {
      console.error("Evaluation not found:", evaluationId);
      return;
    }

    const scorePercentage = Math.round((evaluation.totalPoints / evaluation.totalPointsPossible) * 100);

    document.getElementById('evaluationDetails').innerHTML = `
      <div class="grid-2">
        <div>
          <p class="field-label">Task Type</p>
          <p class="field-value">${formatTaskType(evaluation.taskType)}</p>
        </div>
        <div>
          <p class="field-label">Evaluation Date</p>
          <p class="field-value">${formatDate(evaluation.stopTimestamp)}</p>
        </div>
        <div>
          <p class="field-label">Reference Number</p>
          <p class="field-value">${evaluation.referenceNumber || 'N/A'}</p>
        </div>
        <div>
          <p class="field-label">Score</p>
          <p class="field-value">${evaluation.totalPoints}/${evaluation.totalPointsPossible} (${scorePercentage}%)</p>
        </div>
        <div class="grid-span-2">
          <p class="field-label">Feedback</p>
          <p class="field-value">${evaluation.feedback || 'No feedback provided.'}</p>
        </div>
      </div>
    `;

    document.getElementById('disputeForm').setAttribute('data-evaluation-id', evaluationId);

    loadQuestionsForDispute(evaluation);

  }).getAllEvaluations();
}

  function loadQuestionsForDispute(evaluation) {
  const container = document.getElementById('disputeQuestions');
  container.innerHTML = '';

  if (!evaluation.questions.length) {
    container.innerHTML = '<div class="alert alert-warning">No questions found for this evaluation.</div>';
    return;
  }

  evaluation.questions.forEach(q => {
    const highlightClass = q.response === 'no' ? 'highlight-no' : '';
    const feedbackHtml = q.feedback ? `<p class="field-label">Feedback:</p><p class="field-value">${q.feedback}</p>` : '';

    const card = document.createElement('div');
    card.className = `question-card ${highlightClass}`;
    card.innerHTML = `
      <div class="question-header">
        <h3 class="question-text">${q.questionText}</h3>
        <span class="question-points">Score: ${q.pointsEarned}/${q.pointsPossible}</span>
      </div>
      <div class="question-body">
        <p class="field-label">Response:</p>
        <p class="field-value">${q.response === 'yes' ? 'Yes' : 'No'}</p>
        ${feedbackHtml}
        <div class="dispute-checkbox">
          <label><input type="checkbox" name="dispute_question_${q.questionId}" value="${q.questionId}"> Dispute this question</label>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}

  function handleDisputeSubmit(e) {
  e.preventDefault();

  const form = document.getElementById('disputeForm');
  if (!form) return showToast("Dispute form not found.", 'error');

  const evaluationId = form.getAttribute('data-evaluation-id');
  const reasonField = document.getElementById('disputeReason');
  const reason = reasonField ? reasonField.value : '';

  if (!reason) {
    showToast("Please provide a reason for the dispute.", 'warning');
    return;
  }

  const disputedQuestionIds = [];
  document.querySelectorAll('input[name^="dispute_question_"]:checked').forEach(checkbox => {
    disputedQuestionIds.push(checkbox.value);
  });

  if (disputedQuestionIds.length === 0) {
    showToast("Please select at least one question to dispute.", 'warning');
    return;
  }

  const disputeData = {
    evalId: evaluationId,
    reason,
    questionIds: disputedQuestionIds,
    status: 'pending'
  };

  form.innerHTML = '<div class="loading">Submitting dispute...</div>';

  google.script.run
    .withSuccessHandler(() => {
      showToast("Dispute submitted successfully!", 'success');
      showEvaluations();
    })
    .withFailureHandler(error => {
      form.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
      setTimeout(() => showEvaluations(), 3000);
    })
    .saveDispute(disputeData);
}


  function resolveDispute(disputeId) {
  hideAllViews();
  document.getElementById('resolveDisputeView').classList.remove('hidden');

  google.script.run.withSuccessHandler(function(data) {
    const dispute = data.disputes.find(d => d.id === disputeId);
    const evaluation = data.evaluations.find(e => e.id === dispute.evalId || e.evalId === dispute.evalId);

    if (!dispute || !evaluation) {
      showToast("Dispute or evaluation not found.", 'error');
      return;
    }

    // Update status to "reviewing"
    google.script.run.updateDisputeStatus(dispute.id, 'reviewing');

    // Inject HTML structure for the resolve view
    document.getElementById('resolveDisputeView').innerHTML = `
      <div class="card">
        <h2>Resolve Dispute</h2>
        <div id="resolveEvaluationDetails" class="mb-4">Loading...</div>

        <form id="resolveDisputeForm">
          <div id="resolveDisputeQuestions" class="questions-container mb-4">Loading questions...</div>

          <div class="form-group mt-3">
            <label for="resolutionNotes">General Notes (optional)</label>
            <textarea id="resolutionNotes" name="resolutionNotes" rows="3" class="form-control"></textarea>
          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-primary">Submit Resolution</button>
          </div>
        </form>
      </div>
    `;

    const form = document.getElementById('resolveDisputeForm');
    form.setAttribute('data-eval-id', evaluation.id);
    form.setAttribute('data-dispute-id', dispute.id);

    // Attach the submit handler directly here
    form.addEventListener('submit', handleResolveDisputeSubmit);

    // Render evaluation metadata
    const detailsHTML = `
      <div class="grid-2">
        <div><p class="field-label">Reference</p><p class="field-value">${evaluation.referenceNumber}</p></div>
        <div><p class="field-label">Task Type</p><p class="field-value">${formatTaskType(evaluation.taskType)}</p></div>
        <div><p class="field-label">QA Agent</p><p class="field-value">${evaluation.qaEmail}</p></div>
        <div><p class="field-label">Dispute Reason</p><p class="field-value">${dispute.reason}</p></div>
      </div>
    `;
    document.getElementById('resolveEvaluationDetails').innerHTML = detailsHTML;

    // Render disputed questions
    const container = document.getElementById('resolveDisputeQuestions');
    container.innerHTML = '';

    evaluation.questions.forEach(q => {
      if (!dispute.questionIds.includes(q.questionId)) return;

      const highlightClass = q.response === 'no' ? 'highlight-no' : '';
      const card = document.createElement('div');
      card.className = `question-card ${highlightClass}`;
      card.innerHTML = `
        <div class="question-header">
          <h3 class="question-text">${q.questionText}</h3>
          <span class="question-points">Original: ${q.pointsEarned}/${q.pointsPossible}</span>
        </div>
        <div class="question-body">
          <div class="radio-group">
            <label>
              <input type="radio" name="resolution_${q.questionId}" value="upheld" required>
              <span>Uphold</span>
            </label>
            <label>
              <input type="radio" name="resolution_${q.questionId}" value="overturned">
              <span>Overturn</span>
            </label>
          </div>
          <div class="form-group mt-2">
            <label for="note_${q.questionId}">Justification (required if Upheld)</label>
            <textarea class="form-control" id="note_${q.questionId}" name="note_${q.questionId}" rows="2"></textarea>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }).getAllEvaluationsAndDisputes();
}

  function loadUsers() {
  const tableBody = document.getElementById('usersBody');
  tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

  google.script.run.withSuccessHandler(function(users) {
    if (!users.length) {
      tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">No users found</td></tr>';
      return;
    }

    tableBody.innerHTML = '';
    users.forEach(user => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${user.name}</td>
        <td>${user.email}</td>
        <td>${formatRole(user.role)}</td>
        <td>${user.managerEmail || 'N/A'}</td>
        <td>
          <button class="edit-user-button btn btn-sm btn-primary" data-user-id="${user.id}">Edit</button>
          <button class="delete-user-button btn btn-sm btn-danger" data-user-id="${user.id}">Delete</button>
        </td>
      `;
      tableBody.appendChild(row);
    });

    // Attach listeners
    document.querySelectorAll('.edit-user-button').forEach(btn =>
      btn.addEventListener('click', () => {
        const userId = btn.getAttribute('data-user-id');
        const user = users.find(u => u.id === userId);
        showUserForm(user);
      })
    );

    document.querySelectorAll('.delete-user-button').forEach(btn =>
      btn.addEventListener('click', () => {
        const userId = btn.getAttribute('data-user-id');
        if (confirm('Delete this user?')) deleteUser(userId);
      })
    );
  }).getAllUsers();
}

  function showUserForm(user = null) {
  const isEdit = !!user;
  document.getElementById('userFormTitle').textContent = isEdit ? 'Edit User' : 'Add User';
  document.getElementById('userId').value = user?.id || '';
  document.getElementById('userFormName').value = user?.name || '';
  document.getElementById('userEmail').value = user?.email || '';
  document.getElementById('userFormRole').value = user?.role || 'agent';
  document.getElementById('userManager').value = user?.managerEmail || '';

  document.getElementById('userForm').classList.remove('hidden');
}

function hideUserForm() {
  document.getElementById('userForm').classList.add('hidden');
}

function handleUserFormSubmit(e) {
  e.preventDefault();
  const userId = document.getElementById('userId').value;
  const userData = {
    id: userId,
    name: document.getElementById('userFormName').value,
    email: document.getElementById('userEmail').value,
    role: document.getElementById('userFormRole').value,
    managerEmail: document.getElementById('userManager').value
  };

  const onSuccess = () => {
    showToast(`User ${userId ? 'updated' : 'created'} successfully!`, 'success');;
    hideUserForm();
    loadUsers();
  };

  const onFailure = err => showToast("Error saving user: " + err.message, 'error');

  if (userId) {
    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).updateUser(userData);
  } else {
    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).createUser(userData);
  }
}

function deleteUser(userId) {
  google.script.run
    .withSuccessHandler(() => {
      showToast("User deleted.", 'success');
      loadUsers();
    })
    .withFailureHandler(err => showToast("Error deleting user: " + err.message, 'error'))
    .deleteUser(userId);
}

  function loadQuestions() {
  const tableBody = document.getElementById('questionsBody');
  tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Loading...</td></tr>';

  const filter = document.getElementById('taskTypeFilter').value;

  google.script.run.withSuccessHandler(function(questions) {
    const filtered = filter ? questions.filter(q => q.taskType === filter) : questions;

    if (!filtered.length) {
      tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500">No questions found${filter ? ' for this task type' : ''}</td></tr>`;
      return;
    }

    tableBody.innerHTML = '';
    filtered.forEach(q => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${q.questionText}</td>
        <td>${formatTaskType(q.taskType)}</td>
        <td>${q.pointsPossible}</td>
        <td>
          <button class="edit-question-button btn btn-sm btn-primary" data-question-id="${q.id}">Edit</button>
          <button class="delete-question-button btn btn-sm btn-danger" data-question-id="${q.id}">Delete</button>
        </td>
      `;
      tableBody.appendChild(row);
    });

    document.querySelectorAll('.edit-question-button').forEach(btn =>
      btn.addEventListener('click', () => {
        const qid = btn.getAttribute('data-question-id');
        const question = filtered.find(q => q.id === qid);
        showQuestionForm(question);
      })
    );

    document.querySelectorAll('.delete-question-button').forEach(btn =>
      btn.addEventListener('click', () => {
        const qid = btn.getAttribute('data-question-id');
        if (confirm('Delete this question?')) deleteQuestion(qid);
      })
    );
  }).getAllQuestions();
}

  function showQuestionForm(question = null) {
  const isEdit = !!question;
  document.getElementById('questionFormTitle').textContent = isEdit ? 'Edit Question' : 'Add Question';
  document.getElementById('questionId').value = question?.id || '';
  document.getElementById('questionText').value = question?.questionText || '';
  document.getElementById('questionTaskType').value = question?.taskType || 'phone_call';
  document.getElementById('questionPoints').value = question?.pointsPossible || '10';
  document.getElementById('questionSetId').value = question?.setId || '';

  document.getElementById('questionForm').classList.remove('hidden');
}

function hideQuestionForm() {
  document.getElementById('questionForm').classList.add('hidden');
}

function handleQuestionFormSubmit(e) {
  e.preventDefault();

  const id = document.getElementById('questionId').value;
  const data = {
    id,
    questionText: document.getElementById('questionText').value,
    taskType: document.getElementById('questionTaskType').value,
    pointsPossible: parseInt(document.getElementById('questionPoints').value),
    setId: document.getElementById('questionSetId').value
  };

  const onSuccess = () => {
    showToast(`Question ${id ? 'updated' : 'created'} successfully.`, 'success');
    hideQuestionForm();
    loadQuestions();
  };

  const onFailure = err => showToast("Error saving question: " + err.message, 'error');

  if (id) {
    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).updateQuestion(data);
  } else {
    google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).createQuestion(data);
  }
}

function deleteQuestion(qid) {
  google.script.run
    .withSuccessHandler(() => {
      showToast("Question deleted.", 'success');
      loadQuestions();
    })
    .withFailureHandler(err => showToast("Error deleting question: " + err.message, 'error'))
    .deleteQuestion(qid);
}

  function formatRole(role) {
  if (!role) return 'Unknown';
  return role.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}

function formatTaskType(type) {
  if (!type) return 'Unknown';
  return type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}

  function formatDate(dateStr) {
  if (!dateStr) return 'Unknown';
  const date = new Date(dateStr);
  if (isNaN(date.getTime())) return dateStr;

  const cstOffset = -5; // Adjust as needed for DST
  const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
  const cstDate = new Date(utc + (3600000 * cstOffset));

  return cstDate.toLocaleDateString() + ' ' + cstDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

  function createUser(userData) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler(reject)
      .createUser(userData);
  });
}

  function resetEvaluationForm() {
  const form = document.getElementById('evaluationForm');
  form.reset();

  const questionsContainer = document.getElementById('questions');
  if (questionsContainer) questionsContainer.innerHTML = '';

  const feedbackField = document.getElementById('feedback');
  if (feedbackField) feedbackField.value = '';

  form.removeAttribute('data-audit-id');
  form.removeAttribute('data-reference-number');
  form.removeAttribute('data-task-type');
  form.removeAttribute('data-outcome');
  form.removeAttribute('data-max-score');
}

  function hideAllViews() {
  const views = [
    'dashboardView',
    'auditQueueView',
    'evaluationFormView',
    'evaluationsView',
    'disputesView',
    'disputeFormView',
    'adminView',
    'viewEvaluationView',
    'resolveDisputeView'
  ];

  views.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add('hidden');
  });
}

  // Ensure all navigation and admin event listeners are defined after DOM loads
document.addEventListener('DOMContentLoaded', function () {
  // Fix missing Disputes loader
  if (typeof loadDisputes === 'function') {
    document.getElementById('navDisputes').addEventListener('click', showDisputes);
  }

  // Fix back button on viewEvaluationView
  const closeEvalBtn = document.getElementById('closeViewEvaluation');
  if (closeEvalBtn) {
    closeEvalBtn.addEventListener('click', function () {
      showEvaluations();
    });
  }


  // Ensure admin tab buttons are wired up correctly
  const adminUsersBtn = document.getElementById('adminUsers');
  const adminQuestionsBtn = document.getElementById('adminQuestions');
  const adminSettingsBtn = document.getElementById('adminSettings');

  if (adminUsersBtn) {
    adminUsersBtn.addEventListener('click', () => {
      showAdminTab('adminUsersView');
      loadUsers();
      hideUserForm();
    });
  }

  if (adminQuestionsBtn) {
    adminQuestionsBtn.addEventListener('click', () => {
      showAdminTab('adminQuestionsView');
      loadQuestions();
    });
  }

  if (adminSettingsBtn) {
    adminSettingsBtn.addEventListener('click', () => {
      showAdminTab('adminSettingsView');
    });
  }

  // Ensure Cancel buttons on forms work
  const cancelUserBtn = document.getElementById('cancelUserForm');
  if (cancelUserBtn) {
    cancelUserBtn.addEventListener('click', hideUserForm);
  }

  const cancelQuestionBtn = document.getElementById('cancelQuestionForm');
  if (cancelQuestionBtn) {
    cancelQuestionBtn.addEventListener('click', hideQuestionForm);
  }
});

function handleResolveDisputeSubmit(e) {
  e.preventDefault();

  const form = e.target;
  const evalId = form.getAttribute('data-eval-id');
  const disputeId = form.getAttribute('data-dispute-id');
  const resolutionNotes = document.getElementById('resolutionNotes')?.value || '';

  const decisions = [];
  let overturnCount = 0;

  const cards = document.querySelectorAll('#resolveDisputeQuestions .question-card');
  let hasMissing = false;

  cards.forEach(card => {
    const qid = card.querySelector('input[type="radio"]')?.name?.split('_')[1];
    const selected = form.querySelector(`input[name="resolution_${qid}"]:checked`);
    const note = form.querySelector(`#note_${qid}`)?.value || '';

    if (!selected) {
      showToast('Please make a selection for all disputed questions.', 'warning');
      hasMissing = true;
      return;
    }

    const resolution = selected.value;
    if (resolution === 'upheld' && !note.trim()) {
      showToast('Justification is required for upheld questions.', 'warning');
      hasMissing = true;
      return;
    }

    if (resolution === 'overturned') overturnCount++;

    decisions.push({ questionId: qid, resolution, note });
  });

  if (hasMissing) return;

  const totalDisputed = decisions.length;
  let newStatus = 'upheld';
  if (overturnCount === totalDisputed && totalDisputed > 0) {
    newStatus = 'overturned';
  } else if (overturnCount > 0) {
    newStatus = 'partial overturn';
  }

  google.script.run
    .withSuccessHandler(() => {
      showToast('Dispute resolved successfully.', 'success');
      showDisputes();
    })
    .withFailureHandler(error => {
      console.error('Error resolving dispute:', error);
      showToast('Failed to resolve dispute: ' + error.message, 'error');
    })
    .resolveDispute({
      disputeId,
      evalId,
      decisions,
      resolutionNotes,
      status: newStatus
    });
}

</script>
