// Frontend Logic - Optimized

// On page load
document.addEventListener('DOMContentLoaded', function () {
  initializeApp();
  bindNavigation();
  bindFormEvents();
  startLiveSync();
});

// Initialize app view and user
function initializeApp() {
  google.script.run.withSuccessHandler(function (user) {
    document.getElementById('userName').textContent = user.name;
    document.getElementById('userRole').textContent = formatRole(user.role);

    if (user.role === 'admin' || user.role === 'qa_manager') {
      document.getElementById('navAdmin').style.display = 'block';
    } else {
      document.getElementById('navAdmin').style.display = 'none';
    }

    if (user.role === 'qa_analyst' || user.role === 'qa_manager') {
      showAuditQueue();
    } else {
      showDashboard();
    }
  }).getCurrentUser();
}

function formatRole(role) {
  return role ? role.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : 'Unknown';
}

function bindNavigation() {
  document.getElementById('navDashboard').addEventListener('click', showDashboard);
  document.getElementById('navAuditQueue').addEventListener('click', showAuditQueue);
  document.getElementById('navEvaluations').addEventListener('click', showEvaluations);
  document.getElementById('navDisputes').addEventListener('click', showDisputes);
  document.getElementById('navAdmin').addEventListener('click', showAdmin);
}

function bindFormEvents() {
  document.getElementById('cancelEvaluation').addEventListener('click', cancelEvaluation);
  document.getElementById('evaluationForm').addEventListener('submit', handleEvaluationSubmit);
}

function startLiveSync() {
  setInterval(() => {
    if (!document.getElementById('auditQueueView').classList.contains('hidden')) {
      loadPendingTasks();
    }
  }, 30000);
}

function cancelEvaluation() {
  const form = document.getElementById('evaluationForm');
  const auditId = form.getAttribute('data-audit-id');
  google.script.run.withSuccessHandler(showAuditQueue).updateAuditStatusAndLock(auditId, 'pending');
}

function showDashboard() {
  hideAllViews();
  document.getElementById('dashboardView').classList.remove('hidden');
  highlightNavItem('navDashboard');
  // Optionally reload stats
}

function showAuditQueue() {
  hideAllViews();
  document.getElementById('auditQueueView').classList.remove('hidden');
  highlightNavItem('navAuditQueue');
  loadPendingTasks();
}

function loadPendingTasks() {
  const tableBody = document.getElementById('pendingTasksBody');
  tableBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';

  google.script.run.withSuccessHandler(function (audits) {
    if (!audits.length) {
      tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No pending audits found</td></tr>';
      return;
    }

    tableBody.innerHTML = '';
    audits.forEach(audit => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${audit.agentEmail}</td>
        <td>${formatTaskType(audit.taskType)}</td>
        <td>${audit.referenceNumber || 'N/A'}</td>
        <td>${formatDate(audit.taskTimestamp)}</td>
        <td>${audit.auditStatus}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="showEvaluationForm('${audit.auditId}')">Evaluate</button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }).getPendingAudits();
}

function showEvaluationForm(auditId) {
  hideAllViews();
  document.getElementById('evaluationFormView').classList.remove('hidden');

  google.script.run.withSuccessHandler(function (result) {
    const { audit, questions } = result;
    renderTaskDetails(audit);
    renderEvaluationQuestions(questions);

    const form = document.getElementById('evaluationForm');
    form.setAttribute('data-audit-id', audit.auditId);
    form.setAttribute('data-task-type', audit.taskType);
    form.setAttribute('data-reference-number', audit.referenceNumber || '');
    form.setAttribute('data-outcome', audit.outcome || '');
    form.setAttribute('data-max-score', calculateMaxScore(questions));

  }).prepareEvaluationWithQuestions(auditId);
}

function renderTaskDetails(audit) {
  const container = document.getElementById('taskDetails');
  container.innerHTML = `
    <div class="grid-2">
      <div><p class="field-label">Agent</p><p class="field-value">${audit.agentEmail}</p></div>
      <div><p class="field-label">Task Type</p><p class="field-value">${formatTaskType(audit.taskType)}</p></div>
      <div><p class="field-label">Reference Number</p><p class="field-value">${audit.referenceNumber || 'N/A'}</p></div>
      <div><p class="field-label">Date</p><p class="field-value">${formatDate(audit.taskTimestamp)}</p></div>
      <div><p class="field-label">Request Type</p><p class="field-value">${audit.requestType || 'N/A'}</p></div>
      <div><p class="field-label">Outcome</p><p class="field-value">${audit.outcome || 'N/A'}</p></div>
    </div>
  `;
}

function renderEvaluationQuestions(questions) {
  const container = document.getElementById('questions');
  container.innerHTML = '';
  questions.forEach(q => {
    const element = document.createElement('div');
    element.className = 'question-card';
    element.setAttribute('data-question-id', q.id);
    element.setAttribute('data-question-text', q.questionText);
    element.setAttribute('data-points-possible', q.pointsPossible);
    element.innerHTML = `
      <div class="question-header">
        <h3 class="question-text">${q.questionText}</h3>
        <span class="question-points">Points: ${q.pointsPossible}</span>
      </div>
      <div class="question-body">
        <div class="radio-group">
          <label><input type="radio" name="question_${q.id}" value="yes" required><span>Yes</span></label>
          <label><input type="radio" name="question_${q.id}" value="no"><span>No</span></label>
        </div>
        <div class="feedback-field">
          <label for="feedback_${q.id}">Specific Feedback:</label>
          <textarea id="feedback_${q.id}" name="feedback_${q.id}" rows="2" class="form-control"></textarea>
        </div>
      </div>
    `;
    container.appendChild(element);
  });
}

function calculateMaxScore(questions) {
  return questions.reduce((sum, q) => sum + parseInt(q.pointsPossible), 0);
}

function hideAllViews() {
  document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
}

function highlightNavItem(id) {
  document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function formatTaskType(type) {
  if (!type) return 'N/A';
  return type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return isNaN(date) ? 'Invalid Date' : date.toLocaleDateString();
}
